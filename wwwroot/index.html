<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –í–î–ï</title>
    <style>
        #uaTime {
            color: #9ca3af;
            font-size: 14px;
        }

        .nav {
            display: flex;
            gap: 12px;
        }

        .nav-link {
            color: #9ca3af;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 14px;
            transition: 0.2s;
        }

        .nav-link:hover {
            background: #1f2937;
            color: white;
        }

        .nav-link.active {
            background: #2563eb;
            color: white;
        }

        body {
            margin: 0;
            background: #0f172a;
            color: white;
            font-family: Segoe UI, Roboto, sans-serif;
        }

        header {
            background: #020617;
            padding: 15px 25px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .container {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .card {
            background: #111827;
            padding: 18px;
            border-radius: 14px;
            border: 1px solid #1f2937;
        }

        .card h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .value {
            font-size: 32px;
            font-weight: bold;
            margin-top: 8px;
        }

        .good {
            color: #4ade80;
        }

        .warn {
            color: #facc15;
        }

        .bad {
            color: #f87171;
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 10px;
        }

        button {
            background: #2563eb;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background: #1d4ed8;
        }

        .forecast-box {
            height: 160px;
            background: #0b1220;
            border-radius: 10px;
            border: 1px dashed #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
    </style>
</head>

<body>

<header>
    <div class="title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –í–î–ï</div>

    <nav class="nav">
        <a href="index.html" class="nav-link active">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="forecast.html" class="nav-link">–ü—Ä–æ–≥–Ω–æ–∑–∏</a>
        <a href="history.html" class="nav-link">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–∞–Ω—ñ</a>
        <a href="settings.html" class="nav-link">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>

        <button id="refreshForecastBtn">–û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏</button>
    </nav>

    <!-- !!! —Ç—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Å–∏–º—É–ª—è—Ü—ñ–π–Ω–∏–π —á–∞—Å -->
    <div style="font-size:18px">
        <span id="systemTime">--.--.--, --:--:--</span>
    </div>
</header>


<div class="container">

    <!-- üåû –°–æ–Ω—è—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è -->
    <div class="card">
        <h2>–ü–æ—Ç–æ—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è ‚Äî –°–æ–Ω—è—á–Ω—ñ –ø–∞–Ω–µ–ª—ñ</h2>
        <div class="value good" id="solarPower">0.00 kW</div>
        <div id="solarStatus">‚Äî</div>
    </div>

    <!-- üí® –í—ñ—Ç—Ä–æ–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è -->
    <div class="card">
        <h2>–ü–æ—Ç–æ—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è ‚Äî –í—ñ—Ç—Ä–æ–≤—ñ —Ç—É—Ä–±—ñ–Ω–∏</h2>
        <div class="value good" id="windPower">0.00 kW</div>
        <div id="windStatus">‚Äî</div>
    </div>

    <!-- üå¶Ô∏è –ü–æ—Ç–æ—á–Ω–∞ –ø–æ–≥–æ–¥–∞ (–∑ –ë–î) -->
    <div class="card">
        <h2>–ü–æ—Ç–æ—á–Ω–∞ –ø–æ–≥–æ–¥–∞</h2>
        <div class="value" id="weatherTemp">-- ¬∞C</div>
        <div id="weatherInfo">–•–º–∞—Ä–Ω—ñ—Å—Ç—å: ‚Äî | –í—ñ—Ç–µ—Ä: ‚Äî</div>
    </div>

    <!-- ‚öôÔ∏è –°—Ç–∞—Ç—É—Å -->
    <div class="card">
        <h2>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏</h2>
        <div id="systemStatus">‚Äî</div>
        <h2></h2>
        <h2>–°—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏</h2>
        <div id="systemState">‚Äî</div>
    </div>



    <div class="card">
    <h2>–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ—ó</h2>
    <div class="value" id="batteryCharge">--%</div>
    </div>

    <div class="card">
    <h2>–°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ–π–Ω–∏–π / –∞–≤–∞—Ä—ñ–π–Ω–∏–π —Ä–µ–∂–∏–º</h2>
    <div id="stabilizationStatus">–ó–∞—Ä–∞–∑ –≤–∏–º–∫–Ω–µ–Ω–æ</div>
    <button id="toggleModeBtn">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ä–µ–∂–∏–º</button>
</div>

</div>


<footer>
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞–Ω–∏–º–∏ –¥–∂–µ—Ä–µ–ª–∞–º–∏ –µ–Ω–µ—Ä–≥—ñ—ó
</footer>

    <script>
let simulationTime = null;

// ================== SIM CLOCK ==================
async function initSimulationTime() {
    const res = await fetch("/api/forecast/time");
    const timeStr = await res.json();
    simulationTime = new Date(timeStr);

    setInterval(() => {
        simulationTime.setSeconds(simulationTime.getSeconds() + 1);
        document.getElementById("systemTime").textContent =
            simulationTime.toLocaleString("uk-UA", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            });
    }, 1000);

    // –ü—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Å—É ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ UI
    loadDashboardData();
}

initSimulationTime();

async function loadDashboardData() {
    if (!simulationTime) return;

    const iso = simulationTime.toISOString();

    await Promise.all([
        loadWeather(iso),
        loadGeneration(iso),
        loadConsumption(iso),
        loadDecison(iso)
    ]);
}


// ================== WEATHER ==================
async function loadWeather(timeIso) {
    try {
        const res = await fetch(`/api/weatherdata`);
        const all = await res.json();

        const closest = findClosestByTime(all, "timestamp", simulationTime);

        if (!closest) {
            document.getElementById("weatherInfo").textContent = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
            return;
        }

        document.getElementById("weatherTemp").textContent =
            `${closest.temperature.toFixed(1)} ¬∞C`;

        document.getElementById("weatherInfo").textContent =
            `–•–º–∞—Ä–Ω—ñ—Å—Ç—å: ${closest.cloudiness + 7}%
            –í—ñ—Ç–µ—Ä: ${closest.windSpeed}; 
            –º/—Å, –ù–∞–ø—Ä—è–º –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø—ñ–≤–Ω–æ—á—ñ: ${closest.windDirection}
            –û–ø–∞–¥–∏: ${closest.precipitation}; 
            –í—ñ–¥–Ω–æ—Å–Ω–∞ –≤–æ–ª–æ–≥—ñ—Å—Ç—å: ${closest.humidity}; 
            –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Ç–∏—Å–∫: ${closest.pressure}`;

    } catch (e) {
        console.error(e);
        document.getElementById("weatherInfo").textContent =
            "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ";
    }
}



// ================== GENERATION ==================
async function loadGeneration(timeIso) {
    try {
        const res = await fetch(`/api/forecast`);
        const all = await res.json();

        const lastHour = filterLastHour(all, "timestamp", simulationTime);

        let solar = 0;
        let wind = 0;

lastHour.forEach(x => {
    if (x.forecastType === "Solar") {
        solar += x.value || 0;
    }

    if (x.forecastType === "Wind") {
        wind += x.value || 0;
    }
});
        document.getElementById("solarPower").textContent =
            `${solar.toFixed(2)} Wh`;

        document.getElementById("windPower").textContent =
            `${wind.toFixed(2)} Wh`;

        document.getElementById("solarStatus").textContent =
            solar > 0.3 ? "–°—Ç–∞–±—ñ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è" : "–°–ª–∞–±–∫–µ —Å–æ–Ω—Ü–µ";

        document.getElementById("windStatus").textContent =
            wind > 0.3 ? "–î–æ–±—Ä–∏–π –≤—ñ—Ç–µ—Ä" : "–°–ª–∞–±–∫–∏–π –≤—ñ—Ç–µ—Ä";

    } catch (e) {
        console.error(e);
    }
}



// ================== CONSUMPTION ==================
async function loadConsumption(timeIso) {
    try {
        const res = await fetch(`/api/consumption`);
        const all = await res.json();

        const lastHour = filterLastHour(all, "timestamp", simulationTime);

        console.log(lastHour);

        let total = 0;
        lastHour.forEach(x => total += x.demandKWh || 0);

        document.getElementById("systemStatus").textContent =
            `–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è –º–∏–Ω—É–ª–æ—ó –≥–æ–¥–∏–Ω–∏: ${total.toFixed(2)} kW`;

    } catch (e) {
        console.error(e);
        document.getElementById("systemStatus").textContent =
            "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è";
    }
}



// ================== REFRESH BUTTON ==================
document.getElementById("refreshForecastBtn").addEventListener("click", async () => {
    try {
        const res = await fetch("/api/settings/refresh", { method: "POST" });

        if (!res.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É");

        const text = await res.text();
        alert("–£—Å–ø—ñ—Ö\n" + text);

        // –æ–Ω–æ–≤–∏–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤
        loadDashboardData();

    } catch (e) {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏");
        console.error(e);
    }
});

function parseDate(d) {
    return new Date(d);
}

// –ù–∞–π–±–ª–∏–∂—á–∏–π –∑–∞–ø–∏—Å –¥–æ –º–æ–º–µ–Ω—Ç—É —á–∞—Å—É
function findClosestByTime(arr, timeField, targetTime) {
    let best = null;
    let bestDiff = Infinity;

    arr.forEach(x => {
        const t = parseDate(x[timeField]);
        const diff = Math.abs(t - targetTime);

        if (diff < bestDiff) {
            bestDiff = diff;
            best = x;
        }
    });
    return best;
}

// –ó–∞–ø–∏—Å–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –≥–æ–¥–∏–Ω—É
function filterLastHour(arr, timeField, targetTime) { 
    const from = new Date(Math.ceil((targetTime.getTime() - 60 * 60 * 1000 * 2) / 3600000) * 3600000);
    return arr.filter(x => {
        const t = parseDate(x[timeField]);
        return t > from && t <= targetTime;
    });
}
    
    
async function loadBattery() {
    try {
        const res = await fetch("/api/settings/battery");
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞—Ä—è–¥");
        const value = await res.text();
        document.getElementById("batteryCharge").textContent = value + "%";
    } catch (e) {
        console.error(e);
    }
}

async function loadMode() {
    try {
        const res = await fetch("/api/settings/mode");
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∂–∏–º");
        const mode = await res.text();
        document.getElementById("stabilizationStatus").textContent = 
            mode === "1" ? "–£–≤—ñ–º–∫–Ω–µ–Ω–æ" : "–í–∏–º–∫–Ω–µ–Ω–æ";
    } catch (e) {
        console.error(e);
    }
}

async function toggleMode() {
    try {
        const current = document.getElementById("stabilizationStatus").textContent;
        const newMode = current === "–£–≤—ñ–º–∫–Ω–µ–Ω–æ" ? 0 : 1;
        const res = await fetch(`/api/settings/mode/${newMode}`, { method: "POST" });
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ —Ä–µ–∂–∏–º");
        const updated = await res.text();
        document.getElementById("stabilizationStatus").textContent = 
            updated === "1" ? "–£–≤—ñ–º–∫–Ω–µ–Ω–æ" : "–í–∏–º–∫–Ω–µ–Ω–æ";
    } catch (e) {
        console.error(e);
        alert("–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É");
    }
}

// –ø—Ä–∏–≤'—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
document.getElementById("toggleModeBtn").addEventListener("click", toggleMode);

async function loadDecison(timeIso) {
    try {
        const res = await fetch(`/api/decision`);
        const all = await res.json();

        const closest = findClosestByTime(all, "timestamp", simulationTime);

        if (!closest) {
            document.getElementById("systemState").textContent = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
            return;
        }

        document.getElementById("systemState").textContent =
            `${closest.decisionText}`;

                    console.log("aaa");
        console.log(closest.decisionText);

    } catch (e) {
        console.error(e);
    }
}

// –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å
loadBattery();
loadMode();
    </script>

</body>

</html>